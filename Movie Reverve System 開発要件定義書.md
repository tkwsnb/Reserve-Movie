**作成日**: 2026-01-24
**ステータス**: 要件定義完了 / 実装待ち

## 1. プロジェクト概要
近所の映画館の上映情報を一元管理し、予約から鑑賞記録（Obsidian連携）までをシームレスに行うWebアプリケーションの開発。
既存の予約フローにおける「予約したけど記録し忘れる」「後で思い出せない」という課題を解決する。

## 2. 技術スタック (Tech Stack)
「Pythonではなく、Bun + TypeScriptで統一する」という強い制約のもと設計。

- **Runtime**: Bun (Node.js非使用)
- **Framework**: Hono (Web Standards準拠)
- **Language**: TypeScript
- **Database**: SQLite (`bun:sqlite`)
- **Scraping**: `fetch` + `linkedom` / `HTMLRewriter` (Python/Seleniumは使用しない)
- **Deployment/Output**: Localhost + Google Drive (Obsidian Sync)

## 3. データ収集戦略 (Data Strategy)

### 3.1 映画館マスタの構築
- **ソース**: Movie Walker Press などのポータルサイト
- **手法**:
    1. ポータルサイトの都道府県一覧からクローリング開始。
    2. 各映画館の個別ページURLを取得し、それをユニークIDとして管理。
    3. 補助的にWikidata等を使用し、緯度経度情報を付与（現在地検索用）。

### 3.2 スケジュール取得
- **手法**:
    - 定期実行スクリプト（Worker）により、登録済み映画館のページを解析。
    - サーバー負荷を考慮し、必ず `Wait` 処理を入れる。
    - 取得したデータは `Schedules` テーブルへ Upsert。

## 4. アプリケーション機能要件

### A. メイン画面 (Schedule List)
ユーザーのコンテキストに合わせた「ハイブリッド表示」を採用。

1.  **⭐ お気に入り (Favorites)**
    - ユーザーが指定した「いつもの映画館」を最上部に固定表示。
    - 距離に関係なくアクセス可能にする。
2.  **📍 現在地周辺 (Nearby)**
    - ブラウザの Geolocation API を使用。
    - 現在地から近い順に映画館をソートして表示（出張・旅行先対応）。

### B. トラッキングと「気になるリスト」
直接映画館の予約ページへ飛ばさず、アプリを経由させることでログを残す。

1.  **ユーザーアクション**: スケジュール時間のボタンをクリック。
2.  **システム挙動**:
    - `/api/track` エンドポイントへリクエスト。
    - DBの `Candidates`（気になるリスト）テーブルへ「作品名」「日時」「映画館」を保存。
    - ステータスは `Pending`（未鑑賞）とする。
    - その後、映画館の公式予約ページへ `302 Redirect`。
3.  **メリット**: 予約しなかった場合でも「興味を持った映画」としてリストに残る。

### C. 鑑賞ログとObsidian連携
鑑賞後、アプリから感想を入力し、ローカルのMarkdownファイルとして出力する。

- **トリガー**: 「気になるリスト」から「感想を書く」ボタンを押下。
- **出力先**: Obsidianの `0_Inbox` フォルダ（Google Drive同期下）。
- **ファイル名規則**: `YYYY-MM-DD_作品名.md`

#### 出力テンプレート仕様
```markdown
---
tags: [movie, log]
date: 2026-01-24
created: 2026-01-24
theater: "TOHOシネマズ新宿"
rating: 3
status: watched
image: ""
---

# 作品名

## ログ
- **日時**: 2026-01-24 18:00
- **場所**: TOHOシネマズ新宿
- **公式サイト**: [Link](https://...)
- **予約**: [Link](https://...)

## 感想
(ユーザー入力内容)
5. データベース設計案 (Schema Idea)
Theaters (映画館マスタ)
id: INTEGER PK

name: TEXT

source_url: TEXT (スクレイピング元)

latitude: REAL

longitude: REAL

Schedules (上映スケジュール)
id: INTEGER PK

theater_id: INTEGER FK

movie_title: TEXT

start_time: DATETIME

booking_url: TEXT

Logs / Candidates (鑑賞・候補ログ)
id: INTEGER PK

movie_title: TEXT

theater_name: TEXT

visit_date: DATETIME

status: TEXT ('pending', 'watched', 'cancelled')

obsidian_path: TEXT (出力後のファイルパス)

Generated by Gemini (System Engineer Persona)